# Spring Data JPA基本方法

![spring-data-jpa](../../images/spring-data/Spring-data-jpa.png)

Spring Data JPA给我们提供了非常多的基础方法，其核心方法都在`JpaRepository`/`PagingAndSortingRepository`/`QueryByExampleExecutor`/`CrudRepository`中，
`JpaRepository`继承自`PagingAndSortingRepository`和`QueryByExampleExecutor`，`PagingAndSortingRepository`继承自`CrudRepository`，`CrudRepository`最终继承自`Repository`，此接口没有任何方法，就是一个接口的声明。
在深入学习之前，我们必须首先对这些接口中的方法进行逐个学习。

## CrudRepository里面的样板方法

我们先来看看顶层的CrudRepository接口中声明的方法：
```java
@NoRepositoryBean
public interface CrudRepository<T, ID> extends Repository<T, ID> {
    // 用来插入和修改数据，如果该实体的主键不为空，那么就是修改，否则就是插入。
    // 返回值为修改或者插入后的实体，如果是新增，那么该返回实体将包含主键
    <S extends T> S save(S entity);

    //一次性保存多个实体，该方法的实现默认是循环调用`save(S entity)`方法来实现的
    <S extends T> Iterable<S> saveAll(Iterable<S> entities);

    // 通过实体的ID来查询该实体，如果找到，则返回此实体，如果找不到，则返回一个Optional#empty()
    Optional<T> findById(ID id);

    // 判断此实体ID是否存在，存在为true，不存在为false
    boolean existsById(ID id);

    // 返回数据库表中所有的实体
    Iterable<T> findAll();

    // 查找多个ID的实体，需要注意的是，ids不能为空或者包含null值，而且返回的实体对象列表的顺序和ids的顺序无关
    Iterable<T> findAllById(Iterable<ID> ids);

    // 返回表中所有实体的数量
    long count();

    // 通过实体ID来删除该实体，如果该id不存在，则直接忽略
    void deleteById(ID id);

    // 删除一个给定的实体
    void delete(T entity);

    // 通过多个实体IDs来删除多个实体，ids里面不能包含null值，如果不存在id，则默认给忽略
    void deleteAllById(Iterable<? extends ID> ids);

    // 删除多个实体，entities里面不能包含null值
    void deleteAll(Iterable<? extends T> entities);

    // 删除所有的实体
    void deleteAll();
}
```
## PagingAndSortingRepository提供的样板方法

此接口较为简单，就提供了两个方法：

```java
@NoRepositoryBean
public interface PagingAndSortingRepository<T, ID> extends CrudRepository<T, ID> {

	// 通过排序规则来查找所有的实体
	Iterable<T> findAll(Sort sort);

	// 通过分页或排序规则来查找所有的实体
	Page<T> findAll(Pageable pageable);
}
```

这两个方法都是查询的方法，第一个仅仅为排序的方法，第二个为分页或者排序，下面我们举例来说明：

* 定义Product和ProductRepository
```java
@Entity
@Table(name = "product")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Data
public class Product {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private double price;
}

@Repository
public interface ProductRepository extends PagingAndSortingRepository<Product, Long> {

}
```

* 测试：
```java
@ExtendWith(SpringExtension.class)
@DataJpaTest
@AutoConfigureTestDatabase(replace = AutoConfigureTestDatabase.Replace.NONE)
class ProductRepositoryTest {
    @Autowired
    private ProductRepository productRepository;

    @BeforeEach
    public void initData() {
        Product product = new Product();
        product.setPrice(2.0d);
        product.setName("iphone");

        Product product1 = new Product();
        product1.setPrice(3.0d);
        product1.setName("iphone max");

        Product product2 = new Product();
        product2.setPrice(3.0d);
        product2.setName("ipad");

        Product product3 = new Product();
        product3.setPrice(1.0d);
        product3.setName("max");

        productRepository.saveAll(Arrays.asList(product, product1, product2, product3));
    }

    @Test
    void should_sorted_by_name_and_price() {
        Sort.TypedSort<Product> person = Sort.sort(Product.class);

        //先使用price正序排列，再使用name倒叙
        Sort sort = person.by(Product::getPrice).ascending()
                .and(person.by(Product::getName).descending());
        final List<Product> products = new ArrayList<>();
        productRepository.findAll(sort).forEach(product -> products.add(product));

        assertEquals(4, products.size());
        assertEquals("max", products.get(0).getName());
        assertEquals(1.0, products.get(0).getPrice());
        assertEquals("ipad", products.get(3).getName());
    }

    @Test
    void should_paged_and_sorted() {
        Sort.TypedSort<Product> person = Sort.sort(Product.class);
        Sort sort = person.by(Product::getPrice).ascending();
        final Page<Product> pagedProducts = productRepository.findAll(PageRequest.of(0, 2, sort));

        assertEquals(4, pagedProducts.getTotalElements());
        assertEquals(2, pagedProducts.getTotalPages());
        assertEquals(2, pagedProducts.getContent().size());
        assertEquals("max", pagedProducts.getContent().get(0).getName());
    }
```

## JpaRepository提供的样板方法


## 自定义声明式方法

## JPQL与SQL
