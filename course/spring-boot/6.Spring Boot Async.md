# Spring Boot 异步

![Spring Boot Async](../../images/spring-boot/spring-boot-async.png)

在Spring Boot的开发中，我们遇到的大多数的场景是同步调用的方式，但是有些特殊的场景，同步调用不仅有性能问题，还容易导致同步线程的失败。比如信用卡用户在选择分期还款成功之后，系统将给予两种分期奖励：赠送积分和商家优惠券；这种情况下，如果是同步执行，那么赠送积分和商家优惠券都需要与第三方服务通信，等待时间较长，所以不仅仅延长了用户选择分期还款的等待时间，更重要的是，如果赠送优惠券的第三方服务宕机，将会直接让用户选择分期付款的行为失败，这是不可容忍的。

如果我们使用异步来处理上面的场景：

1. 极大的提升性能：赠送积分和优惠券均与主线程分期还款没有直接的关系，并且耗费时间较长，所以我们将其封装成异步线程来执行，避免阻塞主线程，这样不仅仅让主线程职责单一，同时也让主线程更快的执行，提升用户体验。
2. 提高程序的容错能力：当赠送积分和优惠券的第三方服务宕机之后，仅仅会影响异步线程的执行，我们需要在异步线程中处理这些异常，而对主线程没有影响。

所以，**异步对程序的主要价值有两个：新能和容错能力。**

## Spring Boot 实现异步调用

对于异步方法调用，从Spring3开始提供了`@Async`注解，我们只需要在方法上标注此注解，此方法即可实现异步调用。当然我们还需要开启异步调用，使用注解`@EnableAsync`来标注在SpringBoot启动类上或者单独放在其他配置类上。

例如：
* 定义异步配置类
```java
@Configuration
@EnableAsync
public class AsyncConfiguration {
}
```

* 定义异步任务

```java
@Service
public class Installment {

    @Async
    public void presentExp() throws InterruptedException {
        System.out.println("给分期付款用户赠送100个积分");
        Thread.sleep(2000);
    }

    @Async
    public void givenCoupon() throws InterruptedException {
        System.out.println("给分期用户赠送一张双十一无门槛优惠券！");
        Thread.sleep(4000);
    }
}
```

* 在Controller中调用异步方法：

```java
@RestController
public class InstallmentPayController {

    @Autowired
    private Installment installment;

    @GetMapping("/installment")
    public void installmentPay() throws InterruptedException {
        long t1 = System.currentTimeMillis();
        System.out.println("用户开启分期支付！");
        Thread.sleep(1000);
        installment.presentExp();
        installment.givenCoupon();
        System.out.println("用户分期付款完成！");
        long t2 = System.currentTimeMillis();
        System.out.println("main cost " + (t2 - t1) + " ms");
    }
}
```

测试结果如下：
```bash
用户开启分期支付！
用户分期付款完成！
main cost 1007 ms
给分期付款用户赠送100个积分
给分期用户赠送一张双十一无门槛优惠券！
```

从上面的测试结果我们发现，标记为异步的方法在主线程之后执行了，这就意味着异步方法起效果了。这里有几个关键点需要总结一下：
1. 必须使用`@EnableAsync`来开启异步
2. 被`@Async`注解的方法必须是Public的，返回值为Void或者Future。
3. 方法一定要从外部调用被`@Async`注解的方法，类的内部调用是无效的。

## Spring Boot 使用线程池实现异步调用

## 异步回调

## 异步异常处理